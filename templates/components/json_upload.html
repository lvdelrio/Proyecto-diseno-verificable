{% macro json_upload_button(upload_url, button_text="Subir JSON") %}
{% set component_id = upload_url|replace('.', '_') %}
<div class="relative">
    <button id="jsonUploadBtn_{{ component_id }}" class="bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700 flex items-center">
        <i class="fas fa-file-import mr-2"></i> {{ button_text }}
    </button>
    <div id="jsonUploadDropdown_{{ component_id }}" class="hidden absolute right-0 mt-2 w-64 bg-white rounded-md shadow-lg z-50 p-3 border border-gray-200">
        <form id="bulkUploadForm_{{ component_id }}" enctype="multipart/form-data">
            <div class="mb-3">
                <label class="block text-sm font-medium text-gray-700 mb-1">Seleccionar archivo:</label>
                <input type="file" id="jsonFile_{{ component_id }}" name="jsonFile" accept=".json" 
                    class="block w-full text-sm text-gray-500
                            file:mr-2 file:py-1 file:px-3
                            file:rounded-md file:border-0
                            file:text-sm file:font-semibold
                            file:bg-blue-50 file:text-blue-700
                            hover:file:bg-blue-100" required>
            </div>
            <div class="flex justify-end">
                <button type="button" id="cancelBtn_{{ component_id }}" class="mr-2 px-3 py-1 text-sm text-gray-700 hover:bg-gray-100 rounded">
                    Cancelar
                </button>
                <button type="submit" class="px-3 py-1 bg-green-600 text-white text-sm rounded hover:bg-green-700">
                    <i class="fas fa-upload mr-1"></i> Enviar
                </button>
            </div>
        </form>
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        const componentId = "{{ component_id }}";
        const uploadUrl = "{{ url_for(upload_url) }}";
        const dropdownId = "jsonUploadDropdown_" + componentId;
        const formId = "bulkUploadForm_" + componentId;
        const fileInputId = "jsonFile_" + componentId;
        const uploadBtnId = "jsonUploadBtn_" + componentId;
        const cancelBtnId = "cancelBtn_" + componentId;
        
        const dropdown = document.getElementById(dropdownId);
        const uploadBtn = document.getElementById(uploadBtnId);
        const cancelBtn = document.getElementById(cancelBtnId);
        const form = document.getElementById(formId);
        
        function toggleDropdown() {
            dropdown.classList.toggle('hidden');
        }
        
        uploadBtn.addEventListener('click', toggleDropdown);
        cancelBtn.addEventListener('click', toggleDropdown);
        
        document.addEventListener('click', function(event) {
            if (!dropdown.contains(event.target) && event.target !== uploadBtn && !uploadBtn.contains(event.target)) {
                dropdown.classList.add('hidden');
            }
        });
        
        form.addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const fileInput = document.getElementById(fileInputId);
            const file = fileInput.files[0];
            
            if (!file) {
                alert('Por favor seleccione un archivo JSON');
                return;
            }
            
            try {
                const fileContent = await readFileAsJson(file);
                
                const response = await fetch(uploadUrl, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Accept': 'application/json'
                    },
                    body: JSON.stringify(fileContent)
                });
                
                if (response.ok) {
                    const result = await response.json();
                    alert(result.message);
                    toggleDropdown(); 
                    window.location.reload();
                } else {
                    const error = await response.json();
                    throw new Error(error.message || 'Error al subir el archivo');
                }
            } catch (error) {
                alert('Error: ' + error.message);
                console.error('Error:', error);
            }
        });
        
        function readFileAsJson(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                
                reader.onload = event => {
                    try {
                        const jsonData = JSON.parse(event.target.result);
                        resolve(jsonData);
                    } catch (e) {
                        reject(new Error('El archivo no es un JSON vÃ¡lido'));
                    }
                };
                
                reader.onerror = () => {
                    reject(new Error('Error al leer el archivo'));
                };
                
                reader.readAsText(file);
            });
        }
    });
</script>
{% endmacro %}